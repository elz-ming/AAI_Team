---
title: "Singapore Ridership Analysis, by Team 12"
author: 
  - "Chua Zong Han Lionel"
  - "Lin Zhenming"
  - "Nurul Shaidah Binti Mohamed Shaib"
  - "Poh Weh Lin"
  - "Tamo Cholo Rafael Tandoc"
  
date: 2025-03-11
date-format: "dddd MMM DD, YYYY"

format: 
  html:
    embed-resources: true
    number-sections: false
    toc: true
    toc-depth: 2
---

# Step 0 : Setting up
## 0.1 : Importing Libraries
```{r}
#| eval: true
#| echo: true
#| message: false
#| warning: false

library(tidyverse)
library(knitr)
library(readxl)
library(tidyquant)
library(ggplot2)
library(corrplot)
library(ggcorrplot)
library(gt)
library(dplyr)

```

## 0.2 : Importing Data
### Dataset 1 : Monthly Data
This dataset entails monthly ridership for every month of the year, for 5 years (2019 to 2024)
```{r}
#| eval: true
#| echo: false

# Load the monthly data from the CSV file
monthly_data <- read_csv("Data/monthly_ave_daily_pt_ridership.csv", show_col_types = FALSE) |>
  as_tibble()

# Get first 10 rows of data
monthly_data_top10 <- monthly_data |> head(10)

# Define a function to render monthly data
style_table <- function(data, title = "Styled Table", subtitle = NULL, footnote = NULL) {
  data |>
    gt() |>
    tab_header(
      title = title,
      subtitle = subtitle
    ) |>
    fmt_number(
      columns = where(is.numeric),
      decimals = 2
    ) |>
    # Apply bold, centered text, light blue fill, and borders to column labels
    tab_style(
      style = list(
        cell_text(weight = "bold", align = "center"), # Center-align headers
        cell_fill(color = "lightblue") # Light blue fill
      ),
      locations = cells_column_labels()
    ) |>
    # Explicitly add borders to column labels
    tab_style(
      style = cell_borders(
        sides = c("left", "right", "top", "bottom"), # Apply borders to all sides
        color = "black",
        weight = px(1) # Increase border weight for better visibility
      ),
      locations = cells_column_labels()
    ) |>
    # Apply borders to body cells
    tab_style(
      style = cell_borders(
        sides = c("left", "right", "top", "bottom"),
        color = "black",
        weight = px(1)
      ),
      locations = cells_body()
    ) |>
    # Center-align text in body cells
    tab_style(
      style = cell_text(align = "center"),
      locations = cells_body()
    ) |>
    # Left-align text in footnotes
    tab_style(
      style = cell_text(align = "left"),
      locations = cells_footnotes()
    ) |>
    # Set table options
    tab_options(
      table.font.size = px(14),
      column_labels.font.size = px(16),
      table.width = pct(100),
      table.border.top.style = "solid", # Ensure top border is visible
      table.border.bottom.style = "solid" # Ensure bottom border is visible
    ) |>
    # Add footnote
    tab_footnote(
      footnote = footnote,
      locations = cells_title(groups = "title")
    ) |>
    # Apply top border to footnotes
    tab_style(
      style = cell_borders(
        sides = c("top"),
        color = "black",
        weight = px(1)
      ),
      locations = cells_footnotes()
    )
}

# Apply the styling function to the monthly data
styled_monthly_table <- style_table(
  data = monthly_data_top10,
  title = "Monthly Average Daily Public Transport Ridership",
  subtitle = "Top 10 Rows",
  footnote = "Data sourced from Land Transport Authority (LTA)"
)

# Display the styled table
styled_monthly_table
```


### Dataset 2 : Yearly Data
This dataset entails yearly ridership for for 33 years (1990 to 2023)
```{r}
#| eval: true
#| echo: false

# Load the yearly data from the CSV file
yearly_data <- read_csv("Data/PublicTransportOperationAndRidershipAnnual.csv", show_col_types=FALSE) |>
  as_tibble()


styled_yearly_table <- style_table(
  data = yearly_data,
  title = md("Yearly Public Transport Ridership and Operation Data"),
  subtitle = md("_All Rows_"),
  footnote = "Data sourced from Singapore Department of Statistics"
) |>
  tab_options(
    table.align = "left",  
    heading.align = "left"  
  ) |>
  tab_style(
    style = cell_text(align = "left"),  
    locations = cells_title(groups = c("title", "subtitle"))
  )


# Display the styled table
styled_yearly_table
```

# Step 1 : Data Cleaning and Engineering

## Cleaning Monthly Data

- **Splitting "month" Column into Separate "Month" and "Year" Columns**
  - The **"month"** column contains combined **month-year** values (e.g., `Jan-19`).
  - This step **separates** the **month** and **year** into two distinct columns to facilitate time-based analysis.

```{r}
#| eval: true
#| echo: true

monthly_data <- monthly_data |>
  separate(month, into = c("month", "year"), sep = "-", convert = TRUE) |>
  mutate(
    year = as.numeric(ifelse(year < 100, 2000 + year, year))
  ) |>
  arrange(year, match(month, month.abb), mode)

kable(head(monthly_data))
```

## Cleaning Yearly Data
- **Transpose Table for Better Readability and Analysis**
  - Convert dataset from **wide** to **long** format.
  - Extract the **first row as column names** and remove it.
  - Convert **Year column** to numeric.
```{r}
#| eval: true
#| echo: true

yearly_data <- t(yearly_data)
yearly_data <- as.data.frame(yearly_data)
colnames(yearly_data) <- yearly_data[1, ]
yearly_data <- yearly_data[-1, ]
yearly_data$Year <- as.numeric(rownames(yearly_data))
```

- **Filter Data from 2018 Onwards and Reorganize Columns**
  - Remove records before **2018** to deal with missing data.
  - Reset row names and relocate **Year column** to the first position.
```{r}
#| eval: true
#| echo: true

yearly_data <- yearly_data[yearly_data$Year >= 2018, ]
rownames(yearly_data) <- NULL
yearly_data <- yearly_data |> relocate(Year, .before = everything())
yearly_data <- yearly_data |> rename(`Average Daily Trip - P2P` = `Average Daily Trip - Point-To-Point (P2P) Transport (Taxis And Private Hire Cars)`)
```

- **Convert Ridership Data and MRT/LRT km Operated Data from Thousands to Actual Values**
  - Multiply relevant columns by **1000**.
```{r}
#| eval: true
#| echo: true

# Identify columns to multiply by 1000
columns_to_multiply <- c("MRT km Operated", 
                         "LRT km Operated",
                         "Average Daily Ridership - MRT", 
                         "Average Daily Ridership - LRT", 
                         "Average Daily Ridership - Public Bus", 
                         "Average Daily Trip - P2P")

# Convert these columns to numeric and multiply by 1000
for (col in columns_to_multiply) {
  yearly_data[[col]] <- as.numeric(yearly_data[[col]]) * 1000
}

# Convert character columns to numeric
yearly_data <- yearly_data %>%
  mutate(across(where(is.character), as.numeric))

kable(head(yearly_data))

```

# Step 2 : Generate the Improved Visualization
## 1.1 Old Visualization
::: {#fig1 style="text-align: center;"}
![Figure 1: Original Visualization from the Straits Times (2025)](Data/figure_2.png){width=70%}
:::

## 2.2 Improved Visualization
```{r}

# Create a date column from the month and year columns (assuming month is abbreviated, e.g. "Jan")
monthly_data <- monthly_data %>%
  mutate(date = as.Date(paste(year, month, "01", sep = "-"), format = "%Y-%b-%d"))

# ---------------------------
# MRT Sparkline using Monthly Data
# ---------------------------
monthly_data <- monthly_data %>% filter(!is.na(date))
mrt_data <- monthly_data %>% filter(mode == "MRT")

# Filter data for the range between 2021 and 2022
filtered_data <- mrt_data %>% filter(date >= as.Date("2021-01-01") & date <= as.Date("2022-12-31"))

# Find the lowest ridership within this filtered range
lowest_in_range <- filtered_data %>% filter(ridership == min(ridership))

# Extract the date of this lowest ridership
lowest_date_in_range <- lowest_in_range$date

mrt_sparkline <- ggplot(mrt_data, aes(x = date, y = ridership)) +
  geom_line(color = "#008b8b", linewidth = 1) +
  geom_point(data = mrt_data %>% filter(date == min(date) | date == max(date)),
             aes(x = date, y = ridership),
             color = "#003838", size = 3) +
  # Annotate the start value
  geom_text(data = mrt_data %>% filter(date == min(date)),
            aes(x = date, y = ridership, label = ridership),
            vjust = 1.5, hjust = -0.1, color = "#4D4D4D", size = 4) +
  # Annotate the end value
  geom_text(data = mrt_data %>% filter(date == max(date)),
            aes(x = date, y = ridership, label = ridership),
            vjust = -1, hjust = 1.1, color = "#4D4D4D", size = 4) +
  # Add a vertical line and annotate the lowest value
  geom_vline(xintercept = mrt_data$date[which.min(mrt_data$ridership)],
             linetype = "dotted", color = "red") +
  geom_text(data = mrt_data %>% filter(date == mrt_data$date[which.min(mrt_data$ridership)]),
            aes(x = date, y = ridership, label = round(ridership, 2)),
            vjust = -2, hjust = -0.1, color = "#4D4D4D", size = 4) +
  # Add a vertical line and annotate the lowest value in this range
  geom_vline(xintercept = lowest_date_in_range,
             linetype = "dotted", color = "orange") +
  geom_text(data = lowest_in_range,
            aes(x = date, y = ridership, label = round(ridership, 2)),
            vjust = -2, hjust = 1.1, color = "#4D4D4D", size = 4) +
  # Add Month annotations for specific points
  annotate("text", x = mrt_data$date[which.min(mrt_data$ridership)], y = 0, 
           label = format(mrt_data$date[which.min(mrt_data$ridership)], "%b"), 
           hjust = 0.5, vjust = 2.6, color = "#4D4D4D", size = 3) +
  annotate("text", x = lowest_date_in_range, y = 0, 
           label = format(lowest_date_in_range, "%b"), 
           hjust = 0.5, vjust = 2.6, color = "#4D4D4D", size = 3) +
  labs(x = "", y = "") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(axis.text.y = element_text(angle = 45, hjust = 1)) +
  coord_cartesian(clip = "off")

# ---------------------------
# Bus Sparkline using Monthly Data
# ---------------------------
bus_data <- monthly_data %>% filter(mode == "Public Bus")

# Filter data for the range between 2021 and 2022
filtered_data <- bus_data %>% filter(date >= as.Date("2021-01-01") & date <= as.Date("2022-12-31"))

# Find the lowest ridership within this filtered range
lowest_in_range <- filtered_data %>% filter(ridership == min(ridership))

# Extract the date of this lowest ridership
lowest_date_in_range <- lowest_in_range$date

bus_sparkline <- ggplot(bus_data, aes(x = date, y = ridership)) +
  geom_line(color = "#008b8b", linewidth = 1) +
  geom_point(data = bus_data %>% filter(date == min(date) | date == max(date)),
             aes(x = date, y = ridership),
             color = "#003838", size = 3) +
  geom_text(data = bus_data %>% filter(date == min(date)),
            aes(x = date, y = ridership, label = ridership),
            vjust = 1.5, hjust = -0.1, color = "#4D4D4D", size = 4) +
  geom_text(data = bus_data %>% filter(date == max(date)),
            aes(x = date, y = ridership, label = ridership),
            vjust = -1, hjust = 1.1, color = "#4D4D4D", size = 4) +
  geom_vline(xintercept = bus_data$date[which.min(bus_data$ridership)],
             linetype = "dotted", color = "red") +
  geom_text(data = bus_data %>% filter(date == bus_data$date[which.min(bus_data$ridership)]),
            aes(x = date, y = ridership, label = round(ridership, 2)),
            vjust = -2, hjust = -0.1, color = "#4D4D4D", size = 4) +
  # Add a vertical line and annotate the lowest value in this range
  geom_vline(xintercept = lowest_date_in_range,
             linetype = "dotted", color = "orange") +
  geom_text(data = lowest_in_range,
            aes(x = date, y = ridership, label = round(ridership, 2)),
            vjust = -2, hjust = 1.1, color = "#4D4D4D", size = 4) +
  # Add Month annotations for specific points
  annotate("text", x = bus_data$date[which.min(bus_data$ridership)], y = 0, 
           label = format(bus_data$date[which.min(bus_data$ridership)], "%b"), 
           hjust = 0.5, vjust = 2.6, color = "#4D4D4D", size = 3) +
  annotate("text", x = lowest_date_in_range, y = 0, 
           label = format(lowest_date_in_range, "%b"), 
           hjust = 0.5, vjust = 2.6, color = "#4D4D4D", size = 3) +
  labs(x = "", y = "") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(axis.text.y = element_text(angle = 45, hjust = 1))+
  coord_cartesian(clip = "off")

# ---------------------------
# LRT Sparkline using Monthly Data
# ---------------------------
lrt_data <- monthly_data %>% filter(mode == "LRT")

# Filter data for the range between 2021 and 2022
filtered_data <- lrt_data %>% filter(date >= as.Date("2021-01-01") & date <= as.Date("2022-12-31"))

# Find the lowest ridership within this filtered range
lowest_in_range <- filtered_data %>% filter(ridership == min(ridership))

# Extract the date of this lowest ridership
lowest_date_in_range <- lowest_in_range$date

lrt_sparkline <- ggplot(lrt_data, aes(x = date, y = ridership)) +
  geom_line(color = "#008b8b", linewidth = 1) +
  geom_point(data = lrt_data %>% filter(date == min(date) | date == max(date)),
             aes(x = date, y = ridership),
             color = "#003838", size = 3) +
  geom_text(data = lrt_data %>% filter(date == min(date)),
            aes(x = date, y = ridership, label = ridership),
            vjust = 1.5, hjust = -0.1, color = "#4D4D4D", size = 4) +
  geom_text(data = lrt_data %>% filter(date == max(date)),
            aes(x = date, y = ridership, label = ridership),
            vjust = -1, hjust = 1.1, color = "#4D4D4D", size = 4) +
  geom_vline(xintercept = lrt_data$date[which.min(lrt_data$ridership)],
             linetype = "dotted", color = "red") +
  geom_text(data = lrt_data %>% filter(date == lrt_data$date[which.min(lrt_data$ridership)]),
            aes(x = date, y = ridership, label = round(ridership, 2)),
            vjust = -2, hjust = -0.1, color = "#4D4D4D", size = 4) +
  # Add a vertical line and annotate the lowest value in this range
  geom_vline(xintercept = lowest_date_in_range,
             linetype = "dotted", color = "orange") +
  geom_text(data = lowest_in_range,
            aes(x = date, y = ridership, label = round(ridership, 2)),
            vjust = -2, hjust = 1.1, color = "#4D4D4D", size = 4) +
  # Add Month annotations for specific points
  annotate("text", x = lrt_data$date[which.min(lrt_data$ridership)], y = 0, 
           label = format(lrt_data$date[which.min(lrt_data$ridership)], "%b"), 
           hjust = 0.5, vjust = 2.6, color = "#4D4D4D", size = 3) +
  annotate("text", x = lowest_date_in_range, y = 0, 
           label = format(lowest_date_in_range, "%b"), 
           hjust = 0.5, vjust = 2.6, color = "#4D4D4D", size = 3) +
  labs(x = "", y = "") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(axis.text.y = element_text(angle = 45, hjust = 1, margin = margin(r = 8))) +
  coord_cartesian(clip = "off")

# ---------------------------
# Save sparklines as images
# ---------------------------
ggsave("mrt_sparkline2.png", plot = mrt_sparkline, width = 8, height = 2, dpi = 300)
ggsave("bus_sparkline2.png", plot = bus_sparkline, width = 8, height = 2, dpi = 300)
ggsave("lrt_sparkline2.png", plot = lrt_sparkline, width = 8, height = 2, dpi = 300)

# ---------------------------
# Prepare and Display the Table with Sparklines
# ---------------------------
travel_data <- data.frame(
  Transport = c("MRT", "Bus", "LRT"),
  Trend = c("mrt_sparkline2.png", "bus_sparkline2.png", "lrt_sparkline2.png")
)

travel_table <- gt(travel_data) %>%
  text_transform(
    locations = cells_body(columns = "Trend"),
    fn = function(x) {
      map(x, ~ paste0("<img src='", ., "' style='width:100%; height:auto;'>"))
    }
  ) %>%
  cols_label(
    Transport = "Transport Mode",
    Trend = "Trend (Sparkline)"
  ) %>%
  tab_header(title = "Public Transport Trends (Monthly Data)") %>%
  tab_options(
    table.width = pct(100),
    table.align = "center"
  )

# Display the table
travel_table
```

# Step 3 : Data Analysis
## 3.1 Monthly Ridership Analysis
```{r}
#| eval: true
#| echo: true

# TODO 4: Data analysis using monhtly data

head(monthly_data)

# Check data structure
str(monthly_data)

# Summary statistics
summary(monthly_data)

# Compute Average Monthly Ridership Across Years
monthly_avg_ridership <- monthly_data %>%
  group_by(month) %>%
  summarise(avg_ridership = mean(ridership, na.rm = TRUE))

print(monthly_avg_ridership)

#Compare Monthly Ridership Year Over Year
monthly_yearly_comparison <- monthly_data %>%
  group_by(year, month) %>%
  summarise(total_ridership = sum(ridership, na.rm = TRUE))

print(monthly_yearly_comparison)

# Identify Peak and Low Ridership Months
peak_months <- monthly_data %>%
  group_by(month) %>%
  summarise(avg_ridership = mean(ridership, na.rm = TRUE)) %>%
  arrange(desc(avg_ridership))

print(peak_months)
```

```{r}

# Load necessary library
library(ggplot2)

# Set calendar order for months
monthly_avg_ridership$month <- factor(
  monthly_avg_ridership$month,
  levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun",
             "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
)

# Create a line chart for average ridership per month
ggplot(monthly_avg_ridership, aes(x = month, y = avg_ridership, group = 1)) +
  geom_line(color = "black", size = 1.2) + 
  geom_point(color = "red", size = 3) +
  labs(title = "Average Monthly Public Transport Ridership",
       x = "Month",
       y = "Average Ridership") +
  theme_minimal()


```


Findings:

1. Seasonal Effects and Monthly Trends

- January has the highest ridership (~2,264,133), likely due to the start of the new work and school year.
- February and March also show high ridership, indicating a stable demand in the first quarter.
- July and August ridership remains high, possibly due to increased commuting activity post-school holidays.
- June has the lowest ridership (~1,890,200), aligning with school holidays when fewer students commute.
- May also shows lower ridership, possibly due to exam periods reducing student travel.

Conclusion: Ridership patterns align with Singapore’s school and work calendar, where demand drops during school holidays (June, December) and peaks in January and August.

---

2. Year-over-Year Ridership Trends

- 2020 and 2021 saw a sharp decline in ridership due to COVID-19 lockdowns.
- Ridership shows recovery in 2022 and 2023, but levels have not fully returned to pre-pandemic figures.
- January ridership fluctuates the most across years, reflecting economic and policy changes.

Conclusion: The pandemic had a significant impact on ridership, but recovery trends are visible post-2022.

---

3. Peak and Low Ridership Months

- Peak months: January, March, and September have the highest ridership, suggesting peak travel seasons.
- Lowest months: June and May show the lowest ridership, correlating with school holiday periods.

Conclusion: Adjustments in MRT and bus frequency during low-demand months (June, December) can optimize public transport efficiency.



## 3.2 Infrastructure Expansion Correlation
```{r}
#| eval: true
#| echo: true

# TODO 5: Data analysis using yearly data
```

## 3.3 Impact of Alternative Transport Modes
```{r}
#| eval: true
#| echo: true

# Select only the relevant columns
selected_data <- yearly_data %>%
  select(`Average Daily Ridership - MRT`, 
         `Average Daily Ridership - LRT`, 
         `Average Daily Ridership - Public Bus`, 
         `Average Daily Trip - P2P`)

# Compute correlation matrix
cor_matrix <- cor(selected_data, use = "complete.obs")

ggcorrplot(cor_matrix, 
           lab = TRUE,
           hc.order = TRUE,
           lab_size = 5,        
           colors = c("red", "white", "blue")) +
  ggtitle("Correlation Matrix of Public Transport Usage")

```

## 3.4 Time Series Analysis
```{r}
#| eval: true
#| echo: true

# TODO 7: Data analysis using monthly data
```

